---
import PhoneIcon from '/src/assets/images/phone-no-fill.svg';
import { headerData } from '~/navigation';

interface Props {
  navItems: { text: string; href: string }[];
}

const { navItems } = Astro.props;
const { phoneNumber } = headerData;
const phoneHref = `tel:${phoneNumber.replace(/[^0-9]/g, '')}`;
---

<div
  id="mobile-wrapper"
  class="lg:hidden border-b border-gray-200 fixed inset-x-0 z-[70] pointer-events-none
         opacity-0 invisible transition-[opacity,visibility] duration-150 ease-out"
  data-state="closed"
>
  <div
    id="rb-menu"
    class="overflow-hidden max-h-0 transition-[max-height] duration-150 ease-out bg-white shadow-sm pointer-events-auto"
  >
    <nav class="px-4 pb-5">
      <ul>
        {
          navItems.map((item) => (
            <li class="border-b border-gray-200">
              <a
                href={item.href}
                class="block py-6 text-xl font-bold text-gray-800 hover:text-gray-600 transition-colors"
              >
                {item.text}
              </a>
            </li>
          ))
        }

        <!-- Phone row as the last item -->
        <li class="pt-4">
          <a
            href={phoneHref}
            class="flex items-center gap-x-2 py-3 text-xl font-bold text-gray-800 hover:text-gray-600 transition-colors"
            aria-label={`Call Rock Bookkeeping at ${phoneNumber}`}
          >
            <PhoneIcon class="w-6 h-6 shrink-0" />
            <span>{phoneNumber}</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('rb-toggle');
    const menu = document.getElementById('rb-menu');
    const wrapper = document.getElementById('mobile-wrapper');
    const navBar = document.querySelector('header > nav');
    const iconMenu = toggle?.querySelector('.icon-menu');
    const iconClose = toggle?.querySelector('.icon-close');

    if (!toggle || !menu || !wrapper || !navBar || !iconMenu || !iconClose) return;

    const setTop = () => {
      wrapper.style.top = navBar.offsetHeight + 'px';
    };

    const open = () => {
      toggle.setAttribute('aria-expanded', 'true');
      iconMenu.classList.add('hidden');
      iconClose.classList.remove('hidden');

      menu.style.maxHeight = Math.min(menu.scrollHeight, Math.round(innerHeight * 0.7)) + 'px';

      wrapper.dataset.state = 'open';
      wrapper.style.visibility = 'visible';
      wrapper.style.opacity = '1';
    };

    const close = () => {
      toggle.setAttribute('aria-expanded', 'false');
      iconMenu.classList.remove('hidden');
      iconClose.classList.add('hidden');

      menu.style.maxHeight = '0px';

      wrapper.dataset.state = 'closed';
      wrapper.style.visibility = 'hidden';
      wrapper.style.opacity = '0';
    };

    setTop();
    window.addEventListener('resize', () => {
      setTop();
      if (toggle.getAttribute('aria-expanded') === 'true') {
        menu.style.maxHeight = Math.min(menu.scrollHeight, Math.round(innerHeight * 0.7)) + 'px';
      }
    });

    toggle.addEventListener('click', () => {
      const isOpen = toggle.getAttribute('aria-expanded') === 'true';
      if (isOpen) {
        close();
      } else {
        open();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') close();
    });

    document.addEventListener(
      'click',
      (e) => {
        if (!menu.contains(e.target) && !toggle.contains(e.target)) {
          close();
        }
      },
      true
    );

    menu.querySelectorAll('a').forEach((a) => a.addEventListener('click', close));
  });
</script>
