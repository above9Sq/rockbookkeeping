---
// MobileMenu.astro

import SmsIcon from '/src/assets/images/sms.svg';
import { headerData } from '~/navigation';

interface Props {
  navItems: { text: string; href: string }[];
}

const { navItems } = Astro.props;
const { phoneNumber } = headerData;

const numericPhone = phoneNumber.replace(/[^0-9]/g, '');
const smsHref = `sms:${numericPhone}`;
---

<div
  id="mobile-wrapper"
  class="lg:hidden border-b border-gray-200 fixed inset-x-0 z-[70] pointer-events-none
         opacity-0 invisible transition-[opacity,visibility] duration-150 ease-out"
  data-state="closed"
>
  <div
    id="rb-menu"
    class="overflow-y-auto max-h-0 transition-[max-height] duration-150 ease-out bg-white shadow-sm pointer-events-auto"
  >
    <nav class="px-4 pb-5">
      <ul>
        {
          navItems.map((item) => (
            <li class="border-b border-gray-200">
              <a
                href={item.href}
                class="block py-6 text-xl font-bold text-gray-800 hover:text-gray-600 transition-colors"
              >
                {item.text}
              </a>
            </li>
          ))
        }

        <!-- Contact row at the bottom: Text -->
        <li class="pt-4">
          <div class="flex flex-col gap-2">
            <a
              href={smsHref}
              class="flex items-center justify-center gap-x-4 py-3 px-3
                     text-lg font-semibold text-white
                     bg-[#23335A] rounded-lg
                     hover:bg-[#1d2a4c]
                     transition-colors"
              aria-label={`Text Rock Bookkeeping at ${phoneNumber}`}
            >
              <SmsIcon class="w-6 h-6 shrink-0 text-white" />
              <span>TEXT JOSH: {phoneNumber}</span>
            </a>
          </div>
        </li>
      </ul>
    </nav>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('rb-toggle');
    const menu = document.getElementById('rb-menu');
    const wrapper = document.getElementById('mobile-wrapper');
    const navBar = document.querySelector('header > nav');
    const iconMenu = toggle?.querySelector('.icon-menu');
    const iconClose = toggle?.querySelector('.icon-close');

    if (!toggle || !menu || !wrapper || !navBar || !iconMenu || !iconClose) return;

    const setTop = () => {
      wrapper.style.top = navBar.offsetHeight + 'px';
    };

    const getMaxHeight = () => {
      const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
      const navHeight = navBar.offsetHeight || 0;
      // space available below the nav bar
      return viewportHeight - navHeight;
    };

    const open = () => {
      toggle.setAttribute('aria-expanded', 'true');
      iconMenu.classList.add('hidden');
      iconClose.classList.remove('hidden');

      menu.style.maxHeight = getMaxHeight() + 'px';

      wrapper.dataset.state = 'open';
      wrapper.style.visibility = 'visible';
      wrapper.style.opacity = '1';
    };

    const close = () => {
      toggle.setAttribute('aria-expanded', 'false');
      iconMenu.classList.remove('hidden');
      iconClose.classList.add('hidden');

      menu.style.maxHeight = '0px';

      wrapper.dataset.state = 'closed';
      wrapper.style.visibility = 'hidden';
      wrapper.style.opacity = '0';
    };

    setTop();
    window.addEventListener('resize', () => {
      setTop();
      if (toggle.getAttribute('aria-expanded') === 'true') {
        menu.style.maxHeight = getMaxHeight() + 'px';
      }
    });

    toggle.addEventListener('click', () => {
      const isOpen = toggle.getAttribute('aria-expanded') === 'true';
      if (isOpen) {
        close();
      } else {
        open();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') close();
    });

    document.addEventListener(
      'click',
      (e) => {
        if (!menu.contains(e.target) && !toggle.contains(e.target)) {
          close();
        }
      },
      true
    );

    menu.querySelectorAll('a').forEach((a) => a.addEventListener('click', close));
  });
</script>
