---
// src/components/Header.astro
import { Image } from 'astro:assets';
import logoImage from '/src/assets/images/logo.svg';
import MobileMenu from './MobileMenu.astro';

const navItems = [
  { label: 'Home', href: '#', current: true },
  { label: 'Listings', href: '#' },
  { label: 'Product', href: '#' },
  { label: 'Checkout', href: '#' },
];

const ctaLabel = 'Contact';
---

<header class="sticky top-0 z-[80] w-full bg-white h-16 transition-[height] duration-300 ease-out">
  <nav
    class="relative w-full flex flex-wrap lg:grid lg:grid-cols-12 items-center px-8 xl:px-[120px] mx-auto py-2 lg:py-3 lg:border-b lg:border-gray-200"
  >
    <!-- Logo -->
    <div class="lg:col-span-3 flex items-center">
      <a href="/" class="flex items-center gap-x-1 md:gap-x-2" aria-label="Rock Bookkeeping">
        <Image
          src={logoImage}
          alt="Rock Bookkeeping logo"
          width={50}
          height={50}
          loading="eager"
          class="shrink-0 h-10"
        />
        <span class="font-heading text-lg md:text-2xl font-semibold text-gray-700">Rock&nbsp;Bookkeeping</span>
      </a>
    </div>

    <div class="flex items-center gap-x-1 lg:gap-x-6 ms-auto lg:ps-6 lg:order-3 lg:col-span-9">
      <!-- Desktop nav -->
      <div class="hidden lg:flex lg:items-center lg:gap-x-7">
        {
          navItems.map((item) => (
            <a
              class="text-gray-800 hover:text-gray-600 font-semibold text-sm uppercase tracking-wide transition-colors"
              href={item.href}
              aria-current={item.current ? 'page' : undefined}
            >
              {item.label}
            </a>
          ))
        }
      </div>

      <!-- Desktop CTA: <a> instead of <button> -->
      <a
        href="#contact-modal"
        data-hs-overlay="#contact-modal"
        data-open-modal
        role="button"
        aria-haspopup="dialog"
        aria-controls="contact-modal"
        aria-expanded="false"
        class="hidden lg:inline-flex py-2 px-8 text-sm font-medium rounded-lg border border-blue-600 text-blue-600 hover:border-blue-500 hover:text-blue-500 transition-colors"
      >
        {ctaLabel}
      </a>

      <!-- Mobile toggle -->
      <div class="lg:hidden">
        <button
          id="rb-toggle"
          aria-expanded="false"
          aria-controls="rb-menu"
          aria-label="Toggle navigation"
          class="size-12 ml-2 flex justify-center items-center rounded-xl text-gray-900 hover:bg-gray-100 transition-colors"
        >
          <svg
            class="icon-menu block size-7 stroke-[1.5]"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
          >
            <line x1="3" x2="21" y1="6" y2="6" stroke="currentColor" stroke-linecap="round"></line>
            <line x1="3" x2="21" y1="12" y2="12" stroke="currentColor" stroke-linecap="round"></line>
            <line x1="3" x2="21" y1="18" y2="18" stroke="currentColor" stroke-linecap="round"></line>
          </svg>
          <svg
            class="icon-close hidden size-7 stroke-[1.5]"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
          >
            <path d="M18 6 6 18" stroke="currentColor" stroke-linecap="round"></path>
            <path d="m6 6 12 12" stroke="currentColor" stroke-linecap="round"></path>
          </svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- Mobile Menu (client-only) -->
  <MobileMenu navItems={navItems} ctaLabel={ctaLabel} />
</header>

<script is:inline>
  // === HEADER-SPECIFIC: Mobile CTA + Dynamic Height ===
  const runHeaderScript = () => {
    if (window.innerWidth >= 1024) return;

    const header = document.querySelector('header');
    const wrapper = document.getElementById('mobile-wrapper');
    const cta = document.getElementById('rb-cta');
    const hero = document.querySelector('[data-hero]');

    if (!header || !wrapper || !cta || !hero) return;

    let shouldShowCTA = false;
    header.style.height = '64px';
    wrapper.style.opacity = '0';
    wrapper.style.visibility = 'hidden';

    const showCTA = () => {
      if (shouldShowCTA) return;
      shouldShowCTA = true;
      const h = cta.offsetHeight;
      header.style.height = `${64 + h}px`;
      wrapper.style.opacity = '1';
      wrapper.style.visibility = 'visible';
      cta.classList.remove('opacity-0', 'translate-y-2');
      cta.classList.add('opacity-100', 'translate-y-0');
    };

    const hideCTA = () => {
      if (!shouldShowCTA) return;
      shouldShowCTA = false;
      header.style.height = '64px';
      if (wrapper.dataset.state !== 'open') {
        wrapper.style.opacity = '0';
        wrapper.style.visibility = 'hidden';
      }
      cta.classList.remove('opacity-100', 'translate-y-0');
      cta.classList.add('opacity-0', 'translate-y-2');
    };

    const obs = new IntersectionObserver(([e]) => (e.isIntersecting ? hideCTA() : showCTA()), { threshold: 0.1 });
    obs.observe(hero);

    const menuObs = new MutationObserver(() => {
      if (wrapper.dataset.state === 'open') {
        wrapper.style.opacity = '1';
        wrapper.style.visibility = 'visible';
        cta.classList.remove('opacity-0', 'translate-y-2');
        cta.classList.add('opacity-100', 'translate-y-0');
      } else if (!shouldShowCTA) {
        wrapper.style.opacity = '0';
        wrapper.style.visibility = 'hidden';
        cta.classList.remove('opacity-100', 'translate-y-0');
        cta.classList.add('opacity-0', 'translate-y-2');
      }
    });
    menuObs.observe(wrapper, { attributes: true, attributeFilter: ['data-state'] });
  };

  document.addEventListener('DOMContentLoaded', runHeaderScript);
  window.addEventListener('astro:page-load', runHeaderScript);
</script>
