---
import H2 from '~/components/widgets/H2.astro';
import Container from '~/components/widgets/Container.astro';
import CalButton from './CalButton.astro';
import FAQSchema from '~/components/seo/FAQSchema.astro';
import { faqs as faqData } from '~/faqs';

interface Props {
  bgColor?: string;
}
const { bgColor = '#f8f8f8' } = Astro.props;

// Build schema payload directly from rendered content
const schemaFaqs = faqData.map((f) => ({
  question: f.question,
  // Join paragraphs for the schema answer text
  answer: f.paragraphs.join(' '),
}));
---

<section id="faq" class="py-12 lg:py-22" style={`background-color: ${bgColor}`}>
  <Container>
    <div class="flex flex-col xl:flex-row gap-14 xl:gap-24 items-start max-w-none">
      <div class="w-full xl:w-1/2 xl:sticky xl:top-24">
        <p class="text-sm font-bold uppercase text-gray-600 mb-2">Frequently Asked Questions</p>
        <H2 align="left">Everything You Were About to Ask Us</H2>

        <div class="flex flex-col gap-3 mt-3">
          <p class="text-lg text-gray-700">Still got a question?</p>
          <p class="text-gray-700">We love curveballs.</p>
          <p class="text-lg text-gray-700">Submit a question or book a call.</p>
          <div><CalButton /></div>
        </div>
      </div>

      <div class="w-full xl:w-1/2">
        <div class="bg-white border border-gray-800 rounded-lg p-6 lg:p-8">
          {
            faqData.map((faq) => (
              <details class="group border-b border-gray-300 py-5 first:pt-0 last:border-b-0">
                <summary class="flex items-center items-start gap-4 cursor-pointer list-none select-none">
                  <svg
                    class="w-6 h-6 mt-0.5 text-gray-900 transition-transform duration-300 group-open:rotate-45"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                  <span class="flex-1 text-lg font-bold text-gray-900">{faq.question}</span>
                </summary>

                <div class="answer mt-4 pl-10 pb-2 overflow-hidden">
                  <div class="space-y-4">
                    {faq.paragraphs.map((paragraph) => (
                      <p class="text-lg text-gray-800 leading-relaxed">{paragraph}</p>
                    ))}
                  </div>
                </div>
              </details>
            ))
          }
        </div>
      </div>
    </div>
    <FAQSchema faqs={schemaFaqs} />
  </Container>
</section>

<style>
  .answer {
    height: 0;
    transition: height 240ms ease;
  }
  @media (prefers-reduced-motion: no-preference) {
    .answer {
      will-change: height;
    }
  }

  .leading-relaxed {
    line-height: 1.75;
  }
</style>

<script>
  document.querySelectorAll('details').forEach((details) => {
    const answer = details.querySelector('.answer');
    if (!answer) return;

    if (details.open) answer.style.height = 'auto';

    details.addEventListener('click', (e) => {
      const summary = details.querySelector('summary');
      if (!summary?.contains(e.target)) return;
      e.preventDefault();

      const shouldOpen = !details.open;

      if (shouldOpen) {
        details.open = true;
        const targetHeight = answer.scrollHeight;
        answer.style.height = '0px';
        requestAnimationFrame(() => (answer.style.height = `${targetHeight}px`));
        const onEnd = () => {
          answer.style.height = 'auto';
          answer.removeEventListener('transitionend', onEnd);
        };
        answer.addEventListener('transitionend', onEnd);
      } else {
        const startHeight = answer.scrollHeight;
        answer.style.height = `${startHeight}px`;
        requestAnimationFrame(() => (answer.style.height = '0px'));
        const onEnd = () => {
          details.open = false;
          answer.style.height = '0px';
          answer.removeEventListener('transitionend', onEnd);
        };
        answer.addEventListener('transitionend', onEnd);
      }
    });
  });
</script>
