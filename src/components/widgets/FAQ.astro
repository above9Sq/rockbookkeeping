---
import H2 from '~/components/widgets/H2.astro';
import Container from '~/components/widgets/Container.astro';
import CalButton from '~/components/widgets/CalButton.astro';
import FAQSchema from '~/components/seo/FAQSchema.astro';

import type { FAQItem } from '~/faqs';

interface Props {
  bgColor?: string;
  items: FAQItem[];
  eyebrow?: string;
  heading?: string;
  ctaLabel?: string;
  ctaHref?: string;
  sectionId?: string; // so service pages can use different ids if needed
}

const {
  bgColor = '#F7F9FF',
  items,
  eyebrow = 'Frequently Asked Questions',
  heading = 'Everything You Were About to Ask Us',
  ctaLabel = 'Book a call with Josh',
  ctaHref = '/contact',
  sectionId = 'faq',
} = Astro.props;

const schemaFaqs = items.map((f) => ({
  question: f.question,
  answer: f.paragraphs.join(' '),
}));
---

<section id={sectionId} class="py-16 sm:py-20 lg:py-24" style={`background-color: ${bgColor}`}>
  <Container>
    <div class="flex flex-col xl:flex-row gap-14 xl:gap-24 items-start max-w-none">
      <div class="w-full xl:w-1/2 xl:sticky xl:top-24">
        <p class="text-xs font-semibold tracking-[0.18em] uppercase text-gray-600 mb-2">{eyebrow}</p>

        <H2 align="left">{heading}</H2>

        <div class="flex flex-col gap-3 mt-3">
          <p class="text-base sm:text-lg text-gray-700">Still got a question?</p>
          <p class="text-gray-700">We love curveballs.</p>
          <p class="text-base sm:text-lg text-gray-700">Submit a question or book a call.</p>

          <div class="mt-3">
            <CalButton narrow label={ctaLabel} href={ctaHref} class="w-full sm:w-auto" />
          </div>
        </div>
      </div>

      <div class="w-full xl:w-1/2">
        <div class="bg-white rounded-xl shadow-[0_2px_12px_rgba(0,0,0,0.06)] p-6 lg:p-8">
          {
            items.map((faq) => (
              <details class="group border-b border-gray-200 py-4 first:pt-0 last:border-b-0">
                <summary class="flex items-start gap-4 cursor-pointer list-none select-none">
                  <svg
                    class="w-5 h-5 mt-0.5 text-gray-900 transition-transform duration-300 group-open:rotate-45"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                  <span class="flex-1 text-base sm:text-lg font-semibold text-gray-900">{faq.question}</span>
                </summary>

                <div class="answer overflow-hidden">
                  <div class="answer-inner mt-3 pl-9 pb-2 space-y-3">
                    {faq.paragraphs.map((paragraph) => (
                      <p class="text-sm sm:text-base text-gray-800 leading-relaxed">{paragraph}</p>
                    ))}
                  </div>
                </div>
              </details>
            ))
          }
        </div>
      </div>
    </div>

    <FAQSchema faqs={schemaFaqs} />
  </Container>
</section>

<style>
  .answer {
    height: 0;
    transition: height 240ms ease;
  }
  @media (prefers-reduced-motion: no-preference) {
    .answer {
      will-change: height;
    }
  }

  .leading-relaxed {
    line-height: 1.75;
  }
</style>

<script>
  document.querySelectorAll('details').forEach((details) => {
    const answer = details.querySelector('.answer');
    const icon = details.querySelector('summary svg');
    if (!answer || !icon) return;

    if (details.open) icon.classList.add('rotate-45');

    details.addEventListener('click', (e) => {
      const summary = details.querySelector('summary');
      if (!summary?.contains(e.target)) return;
      e.preventDefault();

      const shouldOpen = !details.open;

      if (shouldOpen) {
        icon.classList.add('rotate-45');
        details.open = true;
        const target = answer.scrollHeight;
        answer.style.height = '0px';
        requestAnimationFrame(() => (answer.style.height = `${target}px`));
        const onEnd = (ev) => {
          if (ev.propertyName !== 'height') return;
          answer.style.height = 'auto';
          answer.removeEventListener('transitionend', onEnd);
        };
        answer.addEventListener('transitionend', onEnd);
      } else {
        icon.classList.remove('rotate-45');
        const start = answer.scrollHeight;
        answer.style.height = `${start}px`;
        requestAnimationFrame(() => (answer.style.height = '0px'));
        const onEnd = (ev) => {
          if (ev.propertyName !== 'height') return;
          details.open = false;
          answer.style.height = '0px';
          answer.removeEventListener('transitionend', onEnd);
        };
        answer.addEventListener('transitionend', onEnd);
      }
    });
  });
</script>
