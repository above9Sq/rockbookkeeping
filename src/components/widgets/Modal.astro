<div
  id="contact-modal"
  class="fixed inset-0 z-90 hidden bg-black/50 backdrop-blur-sm md:backdrop-blur transition-opacity duration-300 flex flex-col"
  role="dialog"
  aria-modal="true"
  aria-labelledby="contact-modal-label"
  aria-describedby="contact-modal-desc"
  tabindex="-1"
>
  <!-- Backdrop + center -->
  <div data-backdrop class="flex w-full justify-center p-4 pt-8 md:min-h-screen md:items-center">
    <!-- Modal card -->
    <div
      data-modal-card
      class="relative w-full max-w-lg rounded-xl bg-white p-6 shadow-2xl sm:p-8 md:overflow-y-auto md:max-h-[85vh] md:mt-[-4vh] animate-[rbFadeDown_0.32s_ease-out_forwards]"
    >
      <!-- Close button -->
      <button
        type="button"
        class="absolute top-4 right-4 rounded-full p-2 text-gray-500 hover:bg-gray-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500"
        aria-label="Close modal"
        data-close-modal
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>

      <!-- Header (always left-aligned now) -->
      <div id="contact-header" class="mb-6 text-left">
        <h2 id="contact-modal-label" class="mb-1 font-heading text-2xl font-semibold text-gray-800">
          Send Josh a Quick Note
        </h2>
        <p id="contact-modal-desc" class="text-sm text-gray-500">
          Tell me what is going on with your books and I will reply personally, usually within one business day.
        </p>
      </div>

      <!-- Form -->
      <form
        id="contact-form"
        name="quick-note"
        method="POST"
        data-netlify="true"
        netlify-honeypot="bot-field"
        class="space-y-4"
      >
        <input type="hidden" name="form-name" value="quick-note" />
        <p class="hidden">
          <label>
            Donâ€™t fill this out if you're human:
            <input name="bot-field" />
          </label>
        </p>

        <!-- Name (required) -->
        <div>
          <label for="name" class="sr-only">Name</label>
          <input
            id="name"
            name="name"
            type="text"
            required
            autocomplete="name"
            placeholder="Name"
            class="w-full rounded-lg border border-gray-300 px-4 py-3 text-sm focus:border-blue-500
                   focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-1 disabled:opacity-50"
          />
        </div>

        <!-- Email (required) -->
        <div>
          <label for="email" class="sr-only">Email</label>
          <input
            id="email"
            name="email"
            type="email"
            required
            autocomplete="email"
            inputmode="email"
            placeholder="you@business.com"
            class="w-full rounded-lg border border-gray-300 px-4 py-3 text-sm focus:border-blue-500
                   focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-1 disabled:opacity-50"
          />
        </div>

        <!-- Phone (optional) -->
        <div>
          <label for="phone" class="sr-only">Phone number (optional)</label>
          <input
            id="phone"
            name="phone"
            type="tel"
            autocomplete="tel"
            inputmode="tel"
            placeholder="Phone number (optional)"
            class="w-full rounded-lg border border-gray-300 px-4 py-3 text-sm focus:border-blue-500
                   focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-1 disabled:opacity-50"
          />
        </div>

        <!-- Message (required) -->
        <div>
          <label for="message" class="sr-only">Message</label>
          <textarea
            id="message"
            name="message"
            rows="4"
            required
            placeholder="Tell me a bit about your business, your books, and what you would like help with."
            class="w-full rounded-lg border border-gray-300 px-4 py-3 text-sm focus:border-blue-500
                   focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-1"
          ></textarea>
        </div>

        <!-- Submit (rounded-lg, all caps) -->
        <button
          id="contact-submit"
          type="submit"
          class="w-full rounded-lg bg-blue-600 py-3 text-sm font-bold uppercase text-white hover:bg-blue-700
                 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2
                 disabled:opacity-50"
        >
          SEND MESSAGE
        </button>

        <!-- Trust text -->
        <p class="mt-2 text-center text-sm text-gray-500">ðŸ”’ 100% private and secure. No spam.</p>
      </form>

      <!-- Success state (hidden by default) -->
      <div id="contact-success" class="hidden text-center py-6">
        <p class="mb-2 text-base font-semibold text-gray-800">Thanks! I received your message.</p>
        <p class="mb-6 text-sm text-gray-500">I will reply personally, usually within one business day.</p>

        <button
          type="button"
          class="inline-flex items-center justify-center rounded-lg bg-[#23335A] px-6 py-2.5
                   text-sm font-semibold uppercase tracking-wide text-white hover:bg-[#1b2746]
                   focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#23335A]/70"
          data-close-modal
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<style is:global>
  /* Force flex when open */
  #contact-modal:not(.hidden) {
    display: flex !important;
  }

  @keyframes rbFadeDown {
    from {
      opacity: 0;
      transform: translateY(-28px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  (() => {
    const modal = document.getElementById('contact-modal');
    const card = modal?.querySelector('[data-modal-card]');
    if (!modal || !card) return;

    const form = document.getElementById('contact-form');
    const headerBlock = document.getElementById('contact-header');
    const successBlock = document.getElementById('contact-success');

    if (!form || !headerBlock || !successBlock) return;

    let lastTrigger = null;

    const resetView = () => {
      // Show header + form, hide success
      headerBlock.classList.remove('hidden');
      form.classList.remove('hidden');
      successBlock.classList.add('hidden');
    };

    const open = (trigger) => {
      lastTrigger = trigger || document.activeElement;
      resetView();
      modal.classList.remove('hidden');
      document.documentElement.classList.add('overflow-hidden');
      modal.focus();
    };

    const close = () => {
      modal.classList.add('hidden');
      document.documentElement.classList.remove('overflow-hidden');
      lastTrigger?.focus();
    };

    // Open modal triggers
    document.querySelectorAll('[data-open-modal]').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        open(btn);
      });
    });

    // Close via any element with data-close-modal (X + success button)
    modal.querySelectorAll('[data-close-modal]').forEach((btn) => {
      btn.addEventListener('click', close);
    });

    // Close on backdrop click
    modal.addEventListener('click', (e) => {
      if (e.target.hasAttribute('data-backdrop')) close();
    });

    // Close ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) close();
    });

    // Simple focus trap
    modal.addEventListener('keydown', (e) => {
      if (e.key !== 'Tab') return;
      const focusables = modal.querySelectorAll(
        'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
      );
      if (!focusables.length) return;

      const first = focusables[0];
      const last = focusables[focusables.length - 1];

      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    });

    // === SIMPLE INLINE VALIDATION FOR REQUIRED FIELDS ===
    const requiredFields = [
      { el: document.getElementById('name'), msg: 'Name is required.' },
      { el: document.getElementById('email'), msg: 'Email is required.' },
      { el: document.getElementById('message'), msg: 'Message is required.' },
    ];

    function showError(input, message) {
      let error = input.nextElementSibling;

      if (!error || !error.dataset.rbError) {
        error = document.createElement('p');
        error.dataset.rbError = 'true';
        error.className = 'mt-1 text-sm leading-tight text-red-600 font-medium';
        input.insertAdjacentElement('afterend', error);
      }

      error.textContent = message;
      input.setAttribute('aria-invalid', 'true');
    }

    function clearError(input) {
      const error = input.nextElementSibling;
      if (error && error.dataset.rbError) {
        error.remove();
      }
      input.removeAttribute('aria-invalid');
    }

    function validateField(fieldObj) {
      const value = fieldObj.el.value.trim();
      if (!value) {
        showError(fieldObj.el, fieldObj.msg);
        return false;
      }
      clearError(fieldObj.el);
      return true;
    }

    requiredFields.forEach((f) => {
      f.el.addEventListener('blur', () => validateField(f));
    });

    // Helper to URL-encode form data for Netlify
    const encode = (formElement) => {
      const formData = new FormData(formElement);
      // Ensure form-name is present
      if (!formData.get('form-name')) {
        formData.set('form-name', 'quick-note');
      }
      return new URLSearchParams(formData).toString();
    };

    // Validate + send to Netlify via fetch, then show success view
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      let allValid = true;
      requiredFields.forEach((f) => {
        if (!validateField(f)) allValid = false;
      });

      if (!allValid) {
        const firstInvalid = form.querySelector('[aria-invalid="true"]');
        firstInvalid?.focus();
        return;
      }

      try {
        await fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: encode(form),
        });

        // If we get here, Netlify has received the submission
        form.reset();
        requiredFields.forEach((f) => clearError(f.el));

        headerBlock.classList.add('hidden');
        form.classList.add('hidden');
        successBlock.classList.remove('hidden');
      } catch (err) {
        console.error('Netlify form submission failed', err);
        // Optional fallback: let the browser do a normal POST
        form.submit();
      }
    });

    // Expose open on window (if you need to call it manually)
    window.openContactModal = open;
  })();
</script>
