---
import type { ImageMetadata } from 'astro';
import { Icon } from 'astro-icon/components';
import Image from '~/components/common/Image.astro';
import PostTags from '~/components/blog/Tags.astro';

import { APP_BLOG } from 'astrowind:config';
import type { Post } from '~/types';

import { getPermalink } from '~/utils/permalinks';
import { findImage } from '~/utils/images';
import { getFormattedDate } from '~/utils/utils';

export interface Props {
  post: Post;
}

const { post } = Astro.props;
const image = (await findImage(post.image)) as ImageMetadata | undefined;

const link = APP_BLOG?.post?.isEnabled ? getPermalink(post.permalink, 'post') : '';
---

<article class={`max-w-md mx-auto md:max-w-none grid gap-6 md:gap-8 ${image ? 'md:grid-cols-2' : ''}`}>
  <!-- Image (if exists) -->
  {
    image && (
      <div class="relative h-0 pb-[56.25%] md:pb-[75%] lg:pb-[56.25%] overflow-hidden rounded-md shadow-md bg-gray-100">
        {link ?
          <a href={link} class="block group">
            <Image
              src={image}
              class="absolute inset-0 w-full h-full object-cover rounded-md transition-transform duration-300 group-hover:scale-105"
              widths={[400, 768]}
              sizes="(max-width: 768px) 100vw, 768px"
              alt={post.title}
              width={768}
              height={432}
              loading="lazy"
              decoding="async"
            />
          </a>
        : <Image
            src={image}
            class="absolute inset-0 w-full h-full object-cover rounded-md"
            widths={[400, 768]}
            sizes="(max-width: 768px) 100vw, 768px"
            alt={post.title}
            width={768}
            height={432}
            loading="lazy"
            decoding="async"
          />
        }
      </div>
    )
  }

  <!-- Text Content -->
  <div class="flex flex-col justify-start mt-2">
    <!-- Metadata Byline -->
    <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-700 mb-3">
      <time datetime={String(post.publishDate)} class="flex items-center font-medium">
        <Icon name="tabler:calendar" class="w-4 h-4 mr-1.5 text-gray-600" />
        {getFormattedDate(post.publishDate)}
      </time>
      {
        post.author && (
          <span class="flex items-center font-medium">
            <Icon name="tabler:user" class="w-4 h-4 mr-1.5 text-gray-600" />
            {post.author.replaceAll('-', ' ')}
          </span>
        )
      }
      {
        post.category && (
          <a href={getPermalink(post.category.slug, 'category')} class="flex items-center font-medium hover:underline">
            <Icon name="tabler:folder" class="w-4 h-4 mr-1.5 text-gray-600" />
            {post.category.title}
          </a>
        )
      }
    </div>

    <!-- Title -->
    <h2 class="text-2xl font-black text-gray-900 leading-tight mb-2">
      {
        link ?
          <a href={link} class="hover:text-blue-600 transition-colors duration-200">
            {post.title}
          </a>
        : post.title
      }
    </h2>

    <!-- Excerpt -->
    {post.excerpt && <p class="text-gray-800 text-lg leading-relaxed font-medium mb-4 line-clamp-3">{post.excerpt}</p>}

    <!-- Tags -->
    {
      post.tags && Array.isArray(post.tags) && (
        <footer class="mt-auto">
          <PostTags tags={post.tags} class="text-sm font-medium text-gray-700" />
        </footer>
      )
    }
  </div>
</article>
